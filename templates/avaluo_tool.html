{% extends "base.html" %}

{% block title %}Análisis de Avalúos - IGAC Apps{% endblock %}

{% block page_title %}Análisis de Incremento Catastral{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .num {
        font-feature-settings: "tnum";
        font-variant-numeric: tabular-nums;
        text-align: right;
    }

    .gradient-card {
        background: linear-gradient(135deg, #ffffff 0%, #F8FAFC 100%);
    }

    .truncate-name {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-[1400px] mx-auto">
    <!-- FORMULARIO DE CARGA (SI NO HAY RESULTADOS) -->
    {% if not resultados %}
    <div class="max-w-xl mx-auto bg-white p-8 rounded-2xl border border-gray-200 shadow-sm mt-4">
        <h2 class="text-xl font-bold mb-6 text-gray-900 flex items-center gap-2">
            <span class="material-symbols-outlined text-blue-600">upload_file</span> Cargar Listados Catastrales
        </h2>

        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-3">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">1. Precierre
                        (Base)</label>
                    <input type="file" name="file_pre" id="file_pre" class="hidden" accept=".xlsx,.xls,.csv,.txt" {% if
                        not session_data.name_pre %}required{% endif %}>
                    <label for="file_pre"
                        class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50/50 hover:bg-white hover:border-accent transition-all cursor-pointer group">
                        <span
                            class="material-symbols-outlined text-3xl text-gray-300 mb-2 group-hover:text-accent">upload_file</span>
                        <span class="text-[11px] font-medium text-gray-500 text-center px-2 truncate w-full"
                            id="name_pre">
                            {% if session_data.name_pre %}<b class="text-accent">✓ {{ session_data.name_pre }}</b>{%
                            else %}Arrastra o selecciona{% endif %}
                        </span>
                    </label>
                </div>
                <div class="space-y-3">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">2. Postcierre
                        (Sistema)</label>
                    <input type="file" name="file_post" id="file_post" class="hidden" accept=".xlsx,.xls,.csv,.txt" {%
                        if not session_data.name_post %}required{% endif %}>
                    <label for="file_post"
                        class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50/50 hover:bg-white hover:border-accent transition-all cursor-pointer group">
                        <span
                            class="material-symbols-outlined text-3xl text-gray-300 mb-2 group-hover:text-accent">upload_file</span>
                        <span class="text-[11px] font-medium text-gray-500 text-center px-2 truncate w-full"
                            id="name_post">
                            {% if session_data.name_post %}<b class="text-accent">✓ {{ session_data.name_post }}</b>{%
                            else %}Arrastra o selecciona{% endif %}
                        </span>
                    </label>
                </div>
            </div>

            <div class="space-y-5 border-t border-gray-100 pt-6">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-2 uppercase tracking-wider">Zona a
                        Analizar</label>
                    <select name="zona_filter" id="zona_filter"
                        class="w-full text-sm border-gray-200 rounded-xl focus:ring-accent focus:border-accent py-3">
                        <option value="TODOS">Todas las Zonas (Completo)</option>
                        <option value="URBANO">Urbano (01)</option>
                        <option value="RURAL">Rural (00)</option>
                        <option value="CORREG">Corregimientos (>01)</option>
                    </select>
                </div>

                <div class="bg-gray-50 p-6 rounded-xl border border-gray-100 grid grid-cols-2 gap-4">
                    <div id="div_urbano">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">% Inc. URBANO</label>
                        <input type="number" step="0.01" name="pct_urbano"
                            class="w-full rounded-lg border-gray-200 text-sm focus:ring-accent focus:border-accent"
                            value="0.00">
                    </div>
                    <div id="div_rural">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">% Inc. RURAL</label>
                        <input type="number" step="0.01" name="pct_rural"
                            class="w-full rounded-lg border-gray-200 text-sm focus:ring-accent focus:border-accent"
                            value="0.00">
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider">Muestreo
                            Aleatorio</label>
                        <span id="lblPct" class="text-xs font-bold text-accent">100%</span>
                    </div>
                    <input type="range" name="sample_pct" id="sample_pct" min="1" max="100" value="100"
                        class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-accent"
                        oninput="document.getElementById('lblPct').textContent = this.value + '%'">
                </div>
            </div>

            <button type="submit"
                class="w-full bg-gray-900 text-white py-4 rounded-2xl hover:bg-accent hover:shadow-xl hover:shadow-accent/20 transition-all font-bold text-sm tracking-widest flex justify-center items-center gap-3">
                <span class="material-symbols-outlined">play_arrow</span> EJECUTAR ANÁLISIS
            </button>
        </form>
    </div>
    {% endif %}

    <!-- RESULTADOS (SI EXISTEN) -->
    {% if resultados %}
    <div id="dashboard" class="space-y-6">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-3">
                <span class="material-symbols-outlined text-accent">dashboard</span>
                Estadísticas de la Selección
            </h3>
            <div class="flex gap-2">
                <a href="/clear_analysis"
                    class="bg-white border border-red-200 text-red-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-50 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">delete_sweep</span> Limpiar Sesión
                </a>
            </div>
        </div>

        {% if resultados.stats.sample_mode %}
        <div class="bg-amber-50 border border-amber-200 p-4 rounded-xl flex items-center gap-3 shadow-sm">
            <span class="material-symbols-outlined text-amber-500">science</span>
            <p class="text-xs text-amber-700 font-medium">Modo Muestra Activo: Resultados basados en ~5,000 registros
                para optimizar el rendimiento.</p>
        </div>
        {% endif %}

        <!-- KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-1">
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Registros Procesados</p>
                <p class="text-3xl font-display font-bold text-gray-900">{{ resultados.stats.total_registros_muestra }}
                </p>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-1">
                <p class="text-[10px] text-blue-400 font-bold uppercase tracking-wider">Nuevos</p>
                <p class="text-3xl font-display font-bold text-blue-600">{{ resultados.stats.nuevos }}</p>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-1">
                <p class="text-[10px] text-orange-400 font-bold uppercase tracking-wider">Desaparecidos</p>
                <p class="text-3xl font-display font-bold text-orange-600">{{ resultados.stats.desaparecidos }}</p>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-1">
                <p class="text-[10px] text-red-400 font-bold uppercase tracking-wider">Inconsistencias</p>
                <p class="text-3xl font-display font-bold text-red-600">{{ resultados.stats.inconsistencias }}</p>
            </div>
        </div>

        <!-- Financial Stats -->
        <div class="bg-white p-8 rounded-2xl border border-gray-100 shadow-sm grid grid-cols-2 lg:grid-cols-4 gap-8">
            <div class="border-r border-gray-50 pr-4">
                <p class="text-[9px] text-gray-400 font-bold uppercase mb-2">Promedio Cierre</p>
                <p class="text-xl font-bold text-gray-800">$ {{ "{:,.0f}".format(resultados.stats.mean) }}</p>
            </div>
            <div class="border-r border-gray-50 pr-4">
                <p class="text-[9px] text-gray-400 font-bold uppercase mb-2">Mediana Cierre</p>
                <p class="text-xl font-bold text-blue-700">$ {{ "{:,.0f}".format(resultados.stats.median) }}</p>
            </div>
            <div class="border-r border-gray-50 pr-4">
                <p class="text-[9px] text-gray-400 font-bold uppercase mb-2">Moda Cierre</p>
                <p class="text-xl font-bold text-indigo-700">$ {{ "{:,.0f}".format(resultados.stats.mode) }}</p>
            </div>
            <div>
                <p class="text-[9px] text-gray-400 font-bold uppercase mb-2">Desviación Est.</p>
                <p class="text-xl font-bold text-orange-600">$ {{ "{:,.0f}".format(resultados.stats.std) }}</p>
            </div>
        </div>

        <!-- Detailed Table -->
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/30">
                <h4 class="text-sm font-bold text-gray-700 uppercase tracking-widest">Detalle de Registros Aleatorios
                </h4>
            </div>
            <div class="overflow-x-auto max-h-[500px] overflow-y-auto custom-scrollbar">
                <table class="w-full text-left border-collapse text-[11px]">
                    <thead
                        class="sticky top-0 bg-white border-b border-gray-100 text-gray-400 font-bold uppercase tracking-wider">
                        <tr>
                            <th class="px-4 py-3">Predial</th>
                            <th class="px-4 py-3">Nombre</th>
                            <th class="px-4 py-3 text-right">Base</th>
                            <th class="px-4 py-3 text-right">Poscierre</th>
                            <th class="px-4 py-3 text-center">% Real</th>
                            <th class="px-4 py-3">Estado</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                        {% for item in resultados.data %}
                        <tr class="hover:bg-blue-50/30 transition-colors">
                            <td class="px-4 py-3 font-mono text-gray-500">{{ item.Predial_Nacional }}</td>
                            <td class="px-4 py-3 font-semibold text-gray-700 max-w-[150px] truncate">{{ item.Nombre }}
                            </td>
                            <td class="px-4 py-3 text-right text-gray-500">$ {{ "{:,.0f}".format(item.Base) }}</td>
                            <td class="px-4 py-3 text-right font-bold text-gray-900">$ {{ "{:,.0f}".format(item.Sistema)
                                }}</td>
                            <td
                                class="px-4 py-3 text-center font-bold {% if item.Estado == 'OK' %}text-green-600{% else %}text-red-500{% endif %}">
                                {{ "%.2f"|format(item.Pct_Real * 100) }}%
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-0.5 rounded-full text-[9px] font-bold 
                                    {% if item.Estado == 'OK' %}bg-green-100 text-green-700
                                    {% elif item.Estado == 'NUEVO' %}bg-blue-100 text-blue-700
                                    {% elif item.Estado == 'DESAPARECIDO' %}bg-orange-100 text-orange-700
                                    {% else %}bg-red-100 text-red-700{% endif %}">
                                    {{ item.Estado }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block help_content %}
<div class="space-y-8 text-gray-600">
    <section>
        <h4 class="text-primary font-bold text-sm uppercase tracking-wider border-b pb-2 mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-accent">analytics</span>
            1. Funcionalidad de Análisis
        </h4>
        <p class="text-sm leading-relaxed">Esta herramienta realiza un cruce masivo entre dos archivos (Precierre y
            Postcierre) para asegurar la integridad de los datos catastrales tras un proceso de actualización.</p>
    </section>

    <section>
        <h4 class="text-primary font-bold text-sm uppercase tracking-wider border-b pb-2 mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-accent">rule</span>
            2. Interpretación de Estados
        </h4>
        <div class="space-y-4">
            <div class="flex gap-4">
                <span class="px-3 py-1 bg-green-100 text-green-700 text-[10px] font-bold rounded-lg h-fit">OK</span>
                <p class="text-xs">El predio existe en ambos archivos y su incremento coincide exactamente con el
                    porcentaje redondeado a miles.</p>
            </div>
            <div class="flex gap-4">
                <span class="px-3 py-1 bg-blue-100 text-blue-700 text-[10px] font-bold rounded-lg h-fit">NUEVO</span>
                <p class="text-xs">No existía en el precierre (R1 anterior) pero aparece en el listado de poscierre
                    (Sistema).</p>
            </div>
            <div class="flex gap-4">
                <span
                    class="px-3 py-1 bg-orange-100 text-orange-700 text-[10px] font-bold rounded-lg h-fit">DESAPARECIDO</span>
                <p class="text-xs">Estaba en el precierre pero ha sido eliminado o su código cambió en el sistema
                    actual.</p>
            </div>
            <div class="flex gap-4">
                <span
                    class="px-3 py-1 bg-red-100 text-red-700 text-[10px] font-bold rounded-lg h-fit">INCONSISTENCIA</span>
                <p class="text-xs">Indica un error de cálculo o un redondeo que no sigue el estándar oficial (+/- 1000
                    pesos).</p>
            </div>
        </div>
    </section>

    <section class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
        <h4 class="text-blue-800 font-bold text-xs uppercase tracking-wider mb-2 flex items-center gap-2">
            <span class="material-symbols-outlined text-blue-600">calculate</span>
            Lógica de Redondeo Catastral
        </h4>
        <p class="text-[12px] text-blue-700 italic">El sistema imita la fórmula de Excel: <b>=REDONDEAR(ValorBase * (1 +
                %Inc); -3)</b>. Esta es la base de todos los cálculos masivos del IGAC.</p>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    {% if not resultados %}
    // File inputs detection
    const inputs = ['file_pre', 'file_post'];
    inputs.forEach(id => {
        document.getElementById(id).addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                document.getElementById('name_' + id.split('_')[1]).innerHTML =
                    `<b class="text-accent">✓ ${e.target.files[0].name}</b>`;
            }
        });
    });
    {% endif %}
</script>
{% endblock %}