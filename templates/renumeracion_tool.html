{% extends "base.html" %}

{% block title %}Auditoría de Renumeración - IGAC Apps{% endblock %}

{% block page_title %}Auditoría de Renumeración Catastral{% endblock %}

{% block content %}
<div class="max-w-[1400px] mx-auto">
    <!-- FORMULARIO DE CARGA (SI NO HAY RESULTADOS) -->
    {% if not resultados %}
    <div class="premium-card dark:bg-[#1a1a1a] dark:border-gray-800 p-10 mt-4 relative overflow-hidden">
        <div class="mb-10 border-l-4 border-gray-200 dark:border-gray-700 pl-6">
            <h2 class="text-xl font-display font-bold text-gray-900 dark:text-white uppercase tracking-tighter">04 //
                AUDITORIA
                RENUMERACION
            </h2>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-2 uppercase tracking-widest font-bold">CONTROL DE
                CALIDAD GEOGRÁFICO Y
                ALFANUMÉRICO</p>
        </div>

        <form method="POST" enctype="multipart/form-data" id="form_renum" class="space-y-10">
            <!-- PASO 1: CONFIGURACIÓN DE TIPO -->
            <div class="space-y-6">
                <label class="block text-[10px] font-sans font-bold text-gray-500 uppercase tracking-[0.2em]">01. Fuente
                    del Reporte</label>
                <div class="grid grid-cols-2 gap-6">
                    <div id="label_tipo_1"
                        class="flex-1 p-6 border rounded-2xl bg-white hover:bg-gray-50 cursor-pointer transition-all border-gray-100">
                        <div class="flex items-center gap-4">
                            <input type="radio" name="tipo" value="1" id="tipo_1"
                                class="w-5 h-5 text-gray-900 border-gray-300 focus:ring-gray-400" checked
                                onchange="updateRadioSelection()">
                            <div>
                                <p class="text-xs font-bold text-gray-900 uppercase">01 // Base Alfanumérica</p>
                                <p class="text-[10px] text-gray-400 uppercase mt-1">Sincronización de registros .xlsx /
                                    .csv</p>
                            </div>
                        </div>
                    </div>
                    <label
                        class="relative flex flex-col p-6 border border-gray-100 dark:border-gray-700 rounded-2xl cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-all shadow-none"
                        id="label_tipo_2">
                        <input type="radio" name="tipo" value="2"
                            class="absolute top-4 right-4 text-gray-900 focus:ring-0" onchange="updateRadioSelection()">
                        <span
                            class="text-xs font-sans font-bold text-gray-900 dark:text-white uppercase">Gestor/Operador</span>
                        <span class="text-[9px] font-sans text-gray-400 dark:text-gray-500 mt-2 uppercase">Datos de
                            operadores
                            externos</span>
                    </label>
                </div>
            </div>

            <!-- PASO 2: SELECCIÓN DE FASE -->
            <div class="space-y-6">
                <label class="block text-[10px] font-bold text-gray-500 mb-4 uppercase tracking-widest">02. Fase de la
                    Auditoría</label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="cursor-pointer group">
                        <input type="radio" name="fase" value="1" class="hidden peer" checked
                            onchange="toggleFase(this.value)">
                        <div
                            class="border border-gray-100 dark:border-gray-700 rounded-2xl p-4 bg-gray-50/50 dark:bg-gray-800/50 peer-checked:bg-gray-50 dark:peer-checked:bg-gray-800 peer-checked:text-gray-900 dark:peer-checked:text-white transition-all text-center">
                            <p class="text-[10px] font-bold uppercase text-gray-900 dark:text-white">Validación
                                Alfanumérica</p>
                            <p class="text-[8px] mt-1 font-sans opacity-60 text-gray-500 dark:text-gray-400">Revisión de
                                Números</p>
                        </div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="radio" name="fase" value="2" class="hidden peer" onchange="toggleFase(this.value)">
                        <div
                            class="border border-gray-100 dark:border-gray-700 rounded-2xl p-4 bg-gray-50/50 dark:bg-gray-800/50 peer-checked:bg-gray-50 dark:peer-checked:bg-gray-800 peer-checked:text-gray-900 dark:peer-checked:text-white transition-all text-center">
                            <p class="text-[10px] font-bold uppercase text-gray-900 dark:text-white">Validación
                                Geográfica</p>
                            <p class="text-[8px] mt-1 font-sans opacity-60 text-gray-500 dark:text-gray-400">Cruce de
                                Mapas</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- ADVERTENCIA FASE 2 -->
            <div id="warning_fase2" class="hidden animate-in fade-in slide-in-from-top-2 duration-300">
                <div
                    class="p-6 bg-gray-50/50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 rounded-2xl flex gap-4 text-gray-900 dark:text-white">
                    <span class="material-symbols-outlined text-functional-warning font-light">info</span>
                    <p class="text-[10px] font-sans leading-relaxed uppercase tracking-tight">
                        Nota: La fase geográfica requiere que los números prediales ya hayan sido validados en la fase
                        alfanumérica.
                    </p>
                </div>
            </div>

            <!-- CARGA EXCEL (OBLIGATORIA) -->
            <div class="space-y-4 font-sans">
                <label
                    class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest leading-loose">
                    03. Archivo de Datos (Excel)</label>
                <div class="flex gap-4">
                    <div class="flex-grow">
                        <input type="file" name="file_excel" id="file_excel" class="hidden" accept=".xlsx,.xls"
                            required>
                        <label for="file_excel"
                            class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-2xl bg-gray-50/30 dark:bg-gray-800/30 hover:bg-white dark:hover:bg-gray-800 hover:border-gray-200 dark:hover:border-white transition-all cursor-pointer group">
                            <span id="name_excel"
                                class="text-[10px] font-bold text-gray-400 dark:text-gray-500 text-center px-4 uppercase tracking-widest group-hover:text-gray-900 dark:group-hover:text-white transition-colors">
                                Seleccione el archivo .xlsx
                            </span>
                        </label>
                    </div>
                    <button type="button" id="btn_preanalizar" onclick="preanalizarExcel()"
                        class="bg-gray-50 dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl text-gray-900 dark:text-white px-6 font-bold text-[10px] tracking-widest uppercase hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white transition-all disabled:opacity-30 disabled:cursor-not-allowed"
                        disabled>
                        Pre-analizar
                    </button>
                </div>
            </div>

            <!-- PANEL DE MAPEO DE COLUMNAS -->
            <div id="mapping_panel"
                class="hidden space-y-6 p-8 border border-gray-100 dark:border-gray-700 rounded-2xl bg-gray-50/50 dark:bg-gray-800/50 animate-in zoom-in duration-300">
                <label
                    class="block text-[10px] font-sans font-bold text-gray-900 dark:text-white uppercase tracking-[0.2em] mb-4 underline">Mapeo
                    Manual de Columnas</label>

                <div class="grid grid-cols-3 gap-8">
                    <div class="space-y-3">
                        <label
                            class="block text-[9px] font-bold text-gray-500 dark:text-gray-400 uppercase italic">Columna
                            Número Anterior
                            (CICA/LC)</label>
                        <select name="col_ant" id="col_ant"
                            class="w-full bg-white dark:bg-gray-900 border border-gray-100 dark:border-gray-700 rounded-2xl p-3 text-[11px] font-sans text-gray-900 dark:text-white focus:ring-gray-900 dark:focus:ring-white focus:border-gray-200 dark:focus:border-gray-600 outline-none">
                            <option value="">Detectando...</option>
                        </select>
                    </div>
                    <div class="space-y-3">
                        <label
                            class="block text-[9px] font-bold text-gray-500 dark:text-gray-400 uppercase italic">Columna
                            Número Nuevo
                            (SNC)</label>
                        <select name="col_snc" id="col_snc"
                            class="w-full bg-white dark:bg-gray-900 border border-gray-100 dark:border-gray-700 rounded-2xl p-3 text-[11px] font-sans text-gray-900 dark:text-white focus:ring-gray-900 dark:focus:ring-white focus:border-gray-200 dark:focus:border-gray-600 outline-none">
                            <option value="">Detectando...</option>
                        </select>
                    </div>
                    <div class="space-y-3">
                        <label
                            class="block text-[9px] font-bold text-gray-500 dark:text-gray-400 uppercase italic">Columna
                            Estado</label>
                        <select name="col_estado" id="col_estado"
                            class="w-full bg-white dark:bg-gray-900 border border-gray-100 dark:border-gray-700 rounded-2xl p-3 text-[11px] font-sans text-gray-900 dark:text-white focus:ring-gray-900 dark:focus:ring-white focus:border-gray-200 dark:focus:border-gray-600 outline-none">
                            <option value="">Detectando...</option>
                        </select>
                    </div>
                </div>
                <p class="text-[9px] text-gray-400 font-sans mt-4 uppercase">Verifique que las columnas coincidan con el
                    contenido real de su archivo antes de procesar.</p>
            </div>

            <!-- CARGA GDBS (SOLO FASE 2) -->
            <div id="gdb_inputs" class="hidden space-y-4 animate-in fade-in duration-300">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label
                            class="block text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">GDB
                            Formal</label>
                        <input type="file" name="archivo_gdb_formal" id="gdb_f" class="hidden" accept=".zip">
                        <label for="gdb_f"
                            class="flex flex-col items-center justify-center h-20 border border-dashed border-gray-200 dark:border-gray-700 rounded-2xl bg-gray-50/30 dark:bg-gray-800/30 hover:bg-white dark:hover:bg-gray-800 hover:border-gray-200 dark:hover:border-white transition-all cursor-pointer">
                            <span class="material-symbols-outlined text-gray-300 dark:text-gray-600">map</span>
                            <span class="text-[10px] text-gray-400 dark:text-gray-500 mt-1" id="label_gdb_f">ZIP Capas
                                Normal</span>
                        </label>
                    </div>
                    <div class="space-y-2">
                        <label
                            class="block text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">GDB
                            Informal</label>
                        <input type="file" name="archivo_gdb_informal" id="gdb_i" class="hidden" accept=".zip">
                        <label for="gdb_i"
                            class="flex flex-col items-center justify-center h-20 border border-dashed border-gray-200 dark:border-gray-700 rounded-2xl bg-gray-50/30 dark:bg-gray-800/30 hover:bg-white dark:hover:bg-gray-800 hover:border-gray-200 dark:hover:border-white transition-all cursor-pointer">
                            <span class="material-symbols-outlined text-gray-300 dark:text-gray-600">location_on</span>
                            <span class="text-[10px] text-gray-400 dark:text-gray-500 mt-1" id="label_gdb_i">ZIP Capas
                                Informal</span>
                        </label>
                    </div>
                </div>
            </div>

            <button type="submit"
                class="w-full bg-gray-900 dark:bg-white text-white dark:text-gray-900 py-5 rounded-2xl hover:bg-white dark:hover:bg-gray-900 hover:text-gray-900 dark:hover:text-white border border-gray-900 dark:border-white transition-all font-bold text-[11px] tracking-[0.3em] flex justify-center items-center gap-4 uppercase active:scale-[0.98]">
                <span class="material-symbols-outlined font-light">bolt</span> Procesar Cambios y Guardar
            </button>
        </form>
    </div>

    {% endif %}

    <!-- RESULTADOS (SI EXISTEN) -->
    {% if resultados %}
    <div id="resultado_renum" class="space-y-10 uppercase font-sans">
        <div class="premium-card dark:bg-[#1a1a1a] dark:border-gray-800 p-10 flex items-center justify-between">
            <div class="flex items-center gap-6">
                <div
                    class="w-14 h-14 bg-gray-50 dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl flex items-center justify-center text-gray-900 dark:text-white">
                    <span class="material-symbols-outlined text-3xl font-light">fact_check</span>
                </div>
                <div>
                    <h3
                        class="text-2xl font-display font-bold text-gray-900 dark:text-white flex items-center gap-4 uppercase tracking-tighter">
                        <span
                            class="material-symbols-outlined text-gray-900 dark:text-white font-light">analytics</span>
                        Reporte de Renumeración // Resultados
                    </h3>
                    <p class="text-[10px] text-gray-500 mt-2 font-sans">Predios Auditados: {{ resultados.total_auditado
                        }}</p>
                </div>
            </div>
            <div class="flex gap-4">
                <a href="/renumeracion/excel"
                    class="bg-white dark:bg-gray-900 border border-gray-100 dark:border-gray-700 rounded-2xl text-gray-900 dark:text-white px-6 py-3 text-[10px] font-bold hover:bg-gray-50 dark:hover:bg-gray-800 transition-all flex items-center gap-3 tracking-widest">
                    <span class="material-symbols-outlined text-[18px] font-light">table_view</span> Descargar Excel
                </a>
                <a href="/renumeracion/pdf"
                    class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl text-red-600 px-6 py-3 text-[10px] font-bold hover:bg-red-50 dark:hover:bg-red-900/20 transition-all flex items-center gap-3 tracking-widest">
                    <span class="material-symbols-outlined text-[18px] font-light">picture_as_pdf</span> Descargar PDF
                </a>
                <a href="/clear_renumeracion"
                    class="bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-white border border-gray-100 dark:border-gray-700 px-6 py-3 rounded-2xl font-bold text-[10px] hover:bg-white dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-all flex items-center gap-3 tracking-widest">
                    <span class="material-symbols-outlined text-[18px] font-light">refresh</span> Reiniciar
                </a>
            </div>
        </div>

        <!-- SECCIÓN 1: AUDITORÍA ALFANUMÉRICA -->
        <div class="space-y-4">
            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">description</span>
                {% if resultados.fase_ejecutada == 1 %}Fase 1: Validación Alfanumérica{% else %}Fase 1: Base
                Alfanumérica (Pre-validada){% endif %}
            </h4>


            <div
                class="premium-card dark:bg-[#1a1a1a] dark:border-gray-800 overflow-hidden mt-6 {% if resultados.fase_ejecutada == 2 and not resultados.errores %}hidden{% endif %}">
                <div class="p-8 border-b border-gray-100 dark:border-gray-700 bg-gray-50/30 dark:bg-gray-800/30">
                    <h4
                        class="text-[10px] font-bold text-gray-900 dark:text-white uppercase tracking-[0.2em] border-l-2 border-gray-200 dark:border-gray-600 pl-4">
                        Errores Detectados ({{ resultados.errores|length }})</h4>
                </div>
                <div class="overflow-x-auto max-h-[400px] overflow-y-auto custom-scrollbar">
                    {% if resultados.errores %}
                    <table class="w-full text-left border-collapse text-[11px]">
                        <thead
                            class="sticky top-0 bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 text-gray-400 dark:text-gray-500 font-bold uppercase">
                            <tr>
                                <th class="px-6 py-3">Validación</th>
                                <th class="px-6 py-3">Detalle del Error</th>
                                <th class="px-6 py-3">P. Anterior</th>
                                <th class="px-6 py-3">P. Nuevo (SNC)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50 dark:divide-gray-800">
                            {% for err in resultados.errores %}
                            <tr class="hover:bg-red-50/50 dark:hover:bg-red-900/10 transition-colors uppercase">
                                <td class="px-8 py-5"><span class="font-bold text-red-600 text-xs">{{ err.REGLA
                                        }}</span>
                                </td>
                                <td class="px-8 py-5 text-gray-600 dark:text-gray-400 text-[10px] font-sans">{{
                                    err.DETALLE }}</td>
                                <td class="px-8 py-5 font-sans text-gray-400 dark:text-gray-500">{{ err.ANTERIOR }}</td>
                                <td class="px-8 py-5 font-sans font-bold text-gray-900 dark:text-white">{{ err.NUEVO }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="p-12 text-center">
                        <span
                            class="material-symbols-outlined text-5xl text-functional-success mb-2 font-light">verified</span>
                        <h5 class="text-sm font-bold text-gray-900 dark:text-white">Alfanumérico impecable</h5>
                        <p class="text-[11px] text-gray-400">No se detectaron errores de secuencia o lógica en los
                            códigos.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-4">
            {% for counter in resultados.dashboard_counters %}
            <div
                class="premium-card dark:bg-[#1a1a1a] dark:border-gray-800 p-6 flex flex-col items-center justify-center space-y-2">
                <span class="material-symbols-outlined text-4xl text-gray-900/10 dark:text-white/10">{{ counter.icon
                    }}</span>
                <p class="text-[9px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest text-center">
                    {{ counter.label }}
                </p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ counter.value }}</p>
            </div>
            {% endfor %}
        </div>

        <!-- SECCIÓN 2: AUDITORÍA GEOGRÁFICA -->
        {% if resultados.fase_ejecutada == 2 %}
        <div class="space-y-6">
            <h4 class="text-[10px] font-sans font-bold text-gray-400 uppercase tracking-widest flex items-center gap-3">
                <span class="material-symbols-outlined text-sm font-light">map</span> PHASE_02: SPATIAL_OVERLAY_CRUNCH
                (GDB)
            </h4>

            <div class="premium-card dark:bg-[#1a1a1a] dark:border-gray-800 overflow-hidden">
                <div
                    class="p-8 border-b border-gray-100 dark:border-gray-700 bg-gray-50/30 dark:bg-gray-800/30 flex justify-between items-center">
                    <h4
                        class="text-[10px] font-bold text-gray-900 dark:text-white uppercase tracking-[0.2em] border-l-2 border-gray-200 dark:border-gray-600 pl-4">
                        Registros de Excepción ({{ resultados.errores_geo|length }})</h4>
                </div>
                <div class="overflow-x-auto max-h-[400px] overflow-y-auto custom-scrollbar">
                    {% if resultados.errores_geo %}
                    <table class="w-full text-left border-collapse text-[10px] uppercase font-sans">
                        <thead
                            class="sticky top-0 bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 text-gray-400 dark:text-gray-500 font-bold tracking-widest">
                            <tr>
                                <th class="px-8 py-5">INCIDENCE_TYPE</th>
                                <th class="px-8 py-5">NODE_ID</th>
                                <th class="px-8 py-5">DB_STATUS</th>
                                <th class="px-8 py-5">RECOM_ACTION</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50 dark:divide-gray-800">
                            {% for err in resultados.errores_geo %}
                            <tr class="hover:bg-gray-50/50 dark:hover:bg-gray-800/50 transition-colors">
                                <td class="px-8 py-5">
                                    <div class="flex flex-col gap-1">
                                        <span class="text-gray-900 dark:text-white font-bold">{{ err.TIPO }}</span>
                                        <span class="text-gray-400 dark:text-gray-500 font-normal text-[9px]">{{
                                            err.DETALLE }}</span>
                                    </div>
                                </td>
                                <td class="px-8 py-5 font-bold text-gray-900 dark:text-white">{{ err.CODIGO }}</td>
                                <td class="px-8 py-5">
                                    <span
                                        class="px-3 py-1 border rounded-2xl {% if err.ESTADO_BD == 'ACTIVO' %}border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white bg-functional-success dark:bg-green-900/30{% elif err.ESTADO_BD == 'NO EXISTE EN BD' %}border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white bg-functional-error dark:bg-red-900/30{% else %}border-gray-100 dark:border-gray-700 text-gray-400 bg-gray-50 dark:bg-gray-800{% endif %} font-bold text-[9px] tracking-widest">
                                        {{ err.ESTADO_BD }}
                                    </span>
                                </td>
                                <td class="px-8 py-5 text-gray-900 dark:text-white font-bold tracking-tighter">{{
                                    err.ACCION_SUGERIDA }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="p-16 text-center">
                        <span
                            class="material-symbols-outlined text-5xl text-functional-success mb-4 font-light">public</span>
                        <h5 class="text-xs font-bold text-gray-900 dark:text-white tracking-widest">INTEGRIDAD
                            GEOGRÁFICA VERIFICADA
                        </h5>
                        <p class="text-[10px] text-gray-400 mt-2">Todos los vectores GDB coinciden con el reporte de
                            renumeración.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block help_content %}
<div class="space-y-10 font-sans text-[11px] text-gray-900 dark:text-white uppercase">
    <section>
        <h4
            class="border-b border-gray-100 dark:border-gray-700 pb-2 mb-4 flex items-center gap-3 font-bold tracking-widest text-gray-900 dark:text-white">
            <span class="material-symbols-outlined font-light">verified</span>
            01_PROTOCOLO_AUDITORIA
        </h4>
        <p>Asegura que el cambio de los números prediales antiguos a los nuevos siga las reglas técnicas del IGAC. Evita
            que se pierda la historia de los predios durante la migración.</p>
    </section>

    <section>
        <h4
            class="border-b border-gray-100 dark:border-gray-700 pb-2 mb-4 flex items-center gap-3 font-bold tracking-widest text-gray-900 dark:text-white">
            <span class="material-symbols-outlined font-light">rule</span>
            02_REGLAS_NEGOCIO
        </h4>
        <div class="space-y-4">
            <div class="border border-gray-100 dark:border-gray-700 rounded-2xl p-4">
                <p class="font-bold mb-1 underline">Unicidad</p>
                <p class="text-gray-500 dark:text-gray-400">Un número nuevo no puede estar repetido en dos predios
                    diferentes.</p>
            </div>
            <div class="border border-gray-100 dark:border-gray-700 rounded-2xl p-4">
                <p class="font-bold mb-1 underline">Permanencia</p>
                <p class="text-gray-500 dark:text-gray-400">Si un predio ya tenía un número oficial, este no debería
                    cambiar
                    injustificadamente.</p>
            </div>
            <div class="border border-gray-100 dark:border-gray-700 rounded-2xl p-4">
                <p class="font-bold mb-1 underline">Geografía (Fase 2)</p>
                <p class="text-gray-500 dark:text-gray-400">El número predial debe corresponder exactamente con su
                    ubicación en el mapa.
                </p>
            </div>
        </div>
    </section>

    <section
        class="bg-gray-50 dark:bg-gray-800 p-8 border border-gray-200 dark:border-gray-700 rounded-2xl text-gray-900 dark:text-white">
        <h4
            class="font-bold text-[11px] uppercase tracking-widest mb-4 flex items-center gap-3 border-b border-gray-700 dark:border-gray-600 pb-2">
            <span class="material-symbols-outlined text-gray-400 font-light">info</span>
            SEGURIDAD DE DATOS
        </h4>
        <p class="text-[10px] text-gray-400 dark:text-gray-500 italic">Esta herramienta ayuda a detectar errores antes
            de que la base de
            datos oficial se vea afectada por malas numeraciones.</p>
    </section>
</div>
{% endblock %}

{% block scripts %}
<div id="statusData" data-results="{{ 'true' if resultados else 'false' }}" class="hidden"></div>
<script>
    function updateRadioSelection() {
        const r1 = document.querySelector('input[name="tipo"][value="1"]');
        const r2 = document.querySelector('input[name="tipo"][value="2"]');

        if (document.getElementById('label_tipo_1')) {
            const el1 = document.getElementById('label_tipo_1');
            el1.classList.toggle('border-gray-200', r1.checked);
            el1.classList.toggle('bg-gray-100', r1.checked);
            el1.classList.toggle('border-gray-100', !r1.checked);

            // Dark mode classes
            el1.classList.toggle('dark:bg-gray-800', r1.checked);
            el1.classList.toggle('dark:border-white', r1.checked);
            el1.classList.toggle('dark:bg-gray-900', !r1.checked);
            el1.classList.toggle('dark:border-gray-700', !r1.checked);
        }
        if (document.getElementById('label_tipo_2')) {
            const el2 = document.getElementById('label_tipo_2');
            el2.classList.toggle('border-gray-200', r2.checked);
            el2.classList.toggle('bg-gray-100', r2.checked);
            el2.classList.toggle('border-gray-100', !r2.checked);

            // Dark mode classes
            el2.classList.toggle('dark:bg-gray-800', r2.checked);
            el2.classList.toggle('dark:border-white', r2.checked);
            el2.classList.toggle('dark:bg-gray-900', !r2.checked);
            el2.classList.toggle('dark:border-gray-700', !r2.checked);
        }
    }

    function toggleFase(val) {
        const w2 = document.getElementById('warning_fase2');
        const gdb = document.getElementById('gdb_inputs');

        if (val == "2") {
            if (w2) w2.classList.remove('hidden');
            if (gdb) gdb.classList.remove('hidden');
        } else {
            if (w2) w2.classList.add('hidden');
            if (gdb) gdb.classList.add('hidden');
        }
    }

    async function preanalizarExcel() {
        const fileInput = document.getElementById('file_excel');
        const btn = document.getElementById('btn_preanalizar');
        const panel = document.getElementById('mapping_panel');
        const selAnt = document.getElementById('col_ant');
        const selSnc = document.getElementById('col_snc');
        const selEstado = document.getElementById('col_estado');

        if (!fileInput.files.length) return;

        btn.disabled = true;
        btn.innerHTML = "Analizando...";

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const response = await fetch('/renumeracion/detectar-columnas', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.error) {
                alert("Error: " + data.error);
            } else {
                // Limpiar y poblar
                selAnt.innerHTML = "";
                selSnc.innerHTML = "";
                selEstado.innerHTML = "";

                data.columnas.forEach(col => {
                    const opt1 = document.createElement('option');
                    opt1.value = col; opt1.textContent = col;
                    selAnt.appendChild(opt1);

                    const opt2 = document.createElement('option');
                    opt2.value = col; opt2.textContent = col;
                    selSnc.appendChild(opt2);

                    const opt3 = document.createElement('option');
                    opt3.value = col; opt3.textContent = col;
                    selEstado.appendChild(opt3);
                });

                // Auto-detectar
                const colAntMatch = data.columnas.find(c => c.toUpperCase().includes('CICA') || c.toUpperCase().includes('ANTERIOR') || c.toUpperCase().includes('LC'));
                const colSncMatch = data.columnas.find(c => c.toUpperCase().includes('SNC') || c.toUpperCase().includes('NUEVO'));
                const colEstadoMatch = data.columnas.find(c => c.toUpperCase().includes('ESTADO') || c.toUpperCase().includes('STATUS'));

                if (colAntMatch) selAnt.value = colAntMatch;
                if (colSncMatch) selSnc.value = colSncMatch;
                if (colEstadoMatch) selEstado.value = colEstadoMatch;

                panel.classList.remove('hidden');
            }
        } catch (e) {
            alert("Error de conexión");
        } finally {
            btn.disabled = false;
            btn.innerHTML = "Pre-analizar";
        }
    }

    const statusData = document.getElementById('statusData');
    const hasResults = statusData.dataset.results === 'true';
    if (hasResults === false) {
        document.getElementById('file_excel').addEventListener('change', (e) => {
            const btnPre = document.getElementById('btn_preanalizar');
            const nameDisplay = document.getElementById('name_excel');
            if (e.target.files.length > 0) {
                nameDisplay.innerHTML = '<span class="text-gray-900 dark:text-white font-bold uppercase tracking-tight">✓ ' + e.target.files[0].name.toUpperCase() + '</span>';
                btnPre.disabled = false;
                // Reset panel if file changes
                document.getElementById('mapping_panel').classList.add('hidden');
            } else {
                btnPre.disabled = true;
            }
        });

        const setupFileLabel = (inputId, labelId) => {
            const el = document.getElementById(inputId);
            if (el) {
                el.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        document.getElementById(labelId).innerHTML = '<span class="text-gray-900 dark:text-white font-bold uppercase text-[9px]">✓ ' + e.target.files[0].name.toUpperCase() + '</span>';
                    }
                });
            }
        };

        setupFileLabel('gdb_f', 'label_gdb_f');
        setupFileLabel('gdb_i', 'label_gdb_i');

        updateRadioSelection();
    }
</script>
{% endblock %}