{% extends "base.html" %}

{% block title %}Auditoría de Renumeración - IGAC Apps{% endblock %}

{% block page_title %}Auditoría de Renumeración Catastral{% endblock %}

{% block content %}
<div class="max-w-[1400px] mx-auto">
    <!-- FORMULARIO DE CARGA (SI NO HAY RESULTADOS) -->
    {% if not resultados %}
    <div class="max-w-xl mx-auto bg-white p-8 rounded-2xl border border-gray-200 shadow-sm mt-4">
        <h2 class="text-xl font-bold mb-6 text-gray-900 flex items-center gap-2">
            <span class="material-symbols-outlined text-accent">rule</span> Validar Renumeración
        </h2>

        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            <div class="space-y-4">
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Paso 1: Configuración
                    de Predio Anterior</label>
                <div class="grid grid-cols-2 gap-4">
                    <label
                        class="relative flex flex-col p-4 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all border-gray-200"
                        id="label_tipo_1">
                        <input type="radio" name="tipo" value="1"
                            class="absolute top-4 right-4 text-accent focus:ring-accent" checked
                            onchange="updateRadioSelection()">
                        <span class="text-xs font-bold text-gray-900">CICA</span>
                        <span class="text-[10px] text-gray-400 mt-1">Codes 9xxx</span>
                    </label>
                    <label
                        class="relative flex flex-col p-4 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all border-gray-200"
                        id="label_tipo_2">
                        <input type="radio" name="tipo" value="2"
                            class="absolute top-4 right-4 text-accent focus:ring-accent"
                            onchange="updateRadioSelection()">
                        <span class="text-xs font-bold text-gray-900">LC_PREDIO</span>
                        <span class="text-[10px] text-gray-400 mt-1">Alfanuméricos / ANT</span>
                    </label>
                </div>
            </div>

            <div class="space-y-3">
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Paso 2: Subir Archivo
                    Excel (.xlsx)</label>
                <input type="file" name="archivo_excel" id="archivo_excel" class="hidden" accept=".xlsx" required>
                <label for="archivo_excel"
                    class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-gray-200 rounded-2xl bg-gray-50/50 hover:bg-white hover:border-accent transition-all cursor-pointer group">
                    <span
                        class="material-symbols-outlined text-4xl text-gray-300 mb-2 group-hover:text-accent group-hover:scale-110 transition-transform">upload_file</span>
                    <span class="text-sm font-medium text-gray-500" id="file_label">Seleccionar informe de
                        renumeración</span>
                    <span class="mt-1 text-[10px] text-gray-400">Solo archivos Excel (.xlsx) con columnas SNC y
                        Estado</span>
                </label>
            </div>

            <button type="submit"
                class="w-full bg-gray-900 text-white py-4 rounded-2xl hover:bg-accent hover:shadow-xl hover:shadow-accent/20 transition-all font-bold text-sm tracking-widest flex justify-center items-center gap-3">
                <span class="material-symbols-outlined">analytics</span> EJECUTAR AUDITORÍA
            </button>
        </form>
    </div>
    {% endif %}

    <!-- RESULTADOS (SI EXISTEN) -->
    {% if resultados %}
    <div id="resultado_renum" class="space-y-6">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-3">
                <span class="material-symbols-outlined text-accent">fact_check</span>
                Resultados de Renumeración
            </h3>
            <div class="flex gap-2">
                <a href="/renumeracion/excel"
                    class="bg-gray-900 text-white px-6 py-2 rounded-xl text-xs font-bold hover:bg-accent transition-all flex items-center gap-2 shadow-lg">
                    <span class="material-symbols-outlined text-[18px]">download</span> Descargar Reporte Completo
                </a>
                <a href="/clear_renumeracion"
                    class="bg-white border border-red-200 text-red-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-50 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">delete_sweep</span> Nueva Auditoría
                </a>
            </div>
        </div>

        <!-- KPI Grid per Rules -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
            {% for i in range(1, 7) %}
            {% set rule_key = i ~ ". " %}
            {% set count = 0 %}
            {% for k, v in resultados.stats.items() %}
            {% if rule_key in k %}{% set count = v %}{% endif %}
            {% endfor %}
            <div
                class="bg-white p-4 rounded-2xl border {% if count > 0 %}border-red-100 bg-red-50/30{% else %}border-gray-100{% endif %} shadow-sm flex flex-col gap-1">
                <p
                    class="text-[9px] {% if count > 0 %}text-red-400{% else %}text-gray-400{% endif %} font-bold uppercase">
                    Regla {{ i }}</p>
                <p
                    class="text-2xl font-display font-bold {% if count > 0 %}text-red-600{% else %}text-gray-900{% endif %}">
                    {{ count }}</p>
            </div>
            {% endfor %}
        </div>

        <!-- Summary Table -->
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/30">
                <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Detalle de Errores Encontrados ({{
                    resultados.errores|length }})</h4>
            </div>
            <div class="overflow-x-auto max-h-[500px] overflow-y-auto custom-scrollbar">
                {% if resultados.errores %}
                <table class="w-full text-left border-collapse text-[11px]">
                    <thead
                        class="sticky top-0 bg-white border-b border-gray-100 text-gray-400 font-bold uppercase tracking-wider">
                        <tr>
                            <th class="px-4 py-3">Validación</th>
                            <th class="px-4 py-3">Detalle del Error</th>
                            <th class="px-4 py-3">P. Anterior</th>
                            <th class="px-4 py-3">P. Nuevo (SNC)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                        {% for err in resultados.errores %}
                        <tr class="hover:bg-red-50/30 transition-colors">
                            <td class="px-4 py-3"><span class="font-bold text-red-600">{{ err.REGLA }}</span></td>
                            <td class="px-4 py-3 text-gray-600">{{ err.DETALLE }}</td>
                            <td class="px-4 py-3 font-mono text-gray-400">{{ err.ANTERIOR }}</td>
                            <td class="px-4 py-3 font-mono font-bold text-gray-900">{{ err.NUEVO }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="p-12 text-center">
                    <span class="material-symbols-outlined text-6xl text-green-200 mb-4">task_alt</span>
                    <h5 class="text-lg font-bold text-green-700">¡Todo está perfecto!</h5>
                    <p class="text-sm text-green-600">El listado cumple con las 6 reglas de renumeración técnica.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block help_content %}
<div class="space-y-8 text-gray-600">
    <section>
        <h4 class="text-primary font-bold text-sm uppercase tracking-wider border-b pb-2 mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-accent">inventory</span>
            Auditoría de Renumeración
        </h4>
        <p class="text-sm">Esta herramienta valida que el proceso de cambio de códigos prediales provisionales a
            definitivos (SNC) se haya realizado sin errores lógicos o de secuencia.</p>
    </section>

    <section>
        <h4 class="text-primary font-bold text-sm uppercase tracking-wider border-b pb-2 mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-accent">list_alt</span>
            Las 6 Reglas de Oro
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                <p class="text-xs font-bold text-gray-900 mb-1">1. Unicidad</p>
                <p class="text-[11px]">No se permiten números SNC duplicados. Cada predio debe tener una identificación
                    única.</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                <p class="text-xs font-bold text-gray-900 mb-1">2. Permanencia</p>
                <p class="text-[11px]">Los predios antiguos (no provisionales) deben conservar exactamente su número
                    original en el SNC.</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                <p class="text-xs font-bold text-gray-900 mb-1">3. Limpieza</p>
                <p class="text-[11px]">Los números definitivos no deben contener letras ni códigos temporales que
                    inicien por 9.</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                <p class="text-xs font-bold text-gray-900 mb-1">4. Consecutivos</p>
                <p class="text-[11px]">En manzanas viejas, los terrenos nuevos deben iniciar después del último número
                    existente.</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                <p class="text-xs font-bold text-gray-900 mb-1">5. Reinicio Mza</p>
                <p class="text-[11px]">En manzanas totalmente nuevas, la numeración de terrenos debe iniciar desde 0001.
                </p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                <p class="text-xs font-bold text-gray-900 mb-1">6. Reinicio Sec</p>
                <p class="text-[11px]">En sectores nuevos, la numeración de manzanas debe iniciar desde 01.</p>
            </div>
        </div>
    </section>

    <section class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
        <h4 class="text-blue-800 font-bold text-xs uppercase tracking-wider mb-2 flex items-center gap-2">
            <span class="material-symbols-outlined text-blue-600">info</span>
            Formato de Archivo
        </h4>
        <p class="text-[12px] text-blue-700">El Excel debe contener las columnas: <br>
            <b>- Número predial SNC</b><br>
            <b>- Estado</b> (Solo se auditan los 'ACTIVO')<br>
            <b>- Número predial CICA</b> (O LC_PREDIO según configuración)
        </p>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateRadioSelection() {
        const r1 = document.querySelector('input[value="1"]');
        const r2 = document.querySelector('input[value="2"]');

        document.getElementById('label_tipo_1').classList.toggle('border-accent', r1.checked);
        document.getElementById('label_tipo_1').classList.toggle('bg-blue-50/30', r1.checked);
        document.getElementById('label_tipo_2').classList.toggle('border-accent', r2.checked);
        document.getElementById('label_tipo_2').classList.toggle('bg-blue-50/30', r2.checked);
    }

    {% if not resultados %}
    document.getElementById('archivo_excel').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            document.getElementById('file_label').innerHTML = `<b class="text-accent">✓ ${e.target.files[0].name}</b>`;
        }
    });
    updateRadioSelection();
    {% endif %}
</script>
{% endblock %}