{% extends "base.html" %}

{% block title %}Auditoría de Renumeración - IGAC Apps{% endblock %}

{% block page_title %}Auditoría de Renumeración Catastral{% endblock %}

{% block content %}
<div class="max-w-[1400px] mx-auto">
    <!-- FORMULARIO DE CARGA (SI NO HAY RESULTADOS) -->
    {% if not resultados %}
    <div class="max-w-2xl mx-auto bg-white p-10 border border-gray-900 mt-4">
        <div class="mb-10 border-l-4 border-gray-900 pl-6">
            <h2 class="text-xl font-display font-bold text-gray-900 uppercase tracking-tighter">Herramienta //
                Auditoría de Renumeración</h2>
            <p class="text-[10px] font-mono text-gray-500 mt-2 uppercase">Verificación de la lógica de cambio de números
                prediales y consistencia geográfica.</p>
        </div>

        <form method="POST" enctype="multipart/form-data" id="form_renum" class="space-y-10">
            <!-- PASO 1: CONFIGURACIÓN DE TIPO -->
            <div class="space-y-6">
                <label class="block text-[10px] font-mono font-bold text-gray-500 uppercase tracking-[0.2em]">01. Fuente
                    del Reporte</label>
                <div class="grid grid-cols-2 gap-6">
                    <label
                        class="relative flex flex-col p-6 border cursor-pointer hover:bg-gray-50 transition-all border-gray-900"
                        id="label_tipo_1">
                        <input type="radio" name="tipo" value="1"
                            class="absolute top-4 right-4 text-gray-900 focus:ring-0" checked
                            onchange="updateRadioSelection()">
                        <span class="text-xs font-mono font-bold text-gray-900 uppercase">Maestro CICA</span>
                        <span class="text-[9px] font-mono text-gray-400 mt-2 uppercase">Base de datos oficial
                            IGAC</span>
                    </label>
                    <label
                        class="relative flex flex-col p-6 border cursor-pointer hover:bg-gray-50 transition-all border-gray-200"
                        id="label_tipo_2">
                        <input type="radio" name="tipo" value="2"
                            class="absolute top-4 right-4 text-gray-900 focus:ring-0" onchange="updateRadioSelection()">
                        <span class="text-xs font-mono font-bold text-gray-900 uppercase">Gestor/Operador</span>
                        <span class="text-[9px] font-mono text-gray-400 mt-2 uppercase">Datos de operadores
                            externos</span>
                    </label>
                </div>
            </div>

            <!-- PASO 2: SELECCIÓN DE FASE -->
            <div class="space-y-6">
                <label class="block text-[10px] font-bold text-gray-500 mb-4 uppercase tracking-widest">02. Fase de la
                    Auditoría</label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="cursor-pointer group">
                        <input type="radio" name="fase" value="1" class="hidden peer" checked
                            onchange="toggleFase(this.value)">
                        <div
                            class="border border-gray-900 p-4 bg-white peer-checked:bg-gray-900 peer-checked:text-white transition-all text-center">
                            <p class="text-[10px] font-bold uppercase">Validación Alfanumérica</p>
                            <p class="text-[8px] mt-1 font-mono opacity-60">Revisión de Números</p>
                        </div>
                    </label>
                    <label class="cursor-pointer group">
                        <input type="radio" name="fase" value="2" class="hidden peer" onchange="toggleFase(this.value)">
                        <div
                            class="border border-gray-900 p-4 bg-white peer-checked:bg-gray-900 peer-checked:text-white transition-all text-center">
                            <p class="text-[10px] font-bold uppercase">Validación Geográfica</p>
                            <p class="text-[8px] mt-1 font-mono opacity-60">Cruce de Mapas</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- ADVERTENCIA FASE 2 -->
            <div id="warning_fase2" class="hidden animate-in fade-in slide-in-from-top-2 duration-300">
                <div class="p-6 bg-gray-900 border border-gray-900 flex gap-4 text-white">
                    <span class="material-symbols-outlined text-gray-400 font-light">info</span>
                    <p class="text-[10px] font-mono leading-relaxed uppercase tracking-tight">
                        Nota: La fase geográfica requiere que los números prediales ya hayan sido validados en la fase
                        alfanumérica.
                    </p>
                </div>
            </div>

            <!-- CARGA EXCEL (OBLIGATORIA) -->
            <div class="space-y-4 font-mono">
                <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest leading-loose">
                    03. Archivo de Datos (Excel)</label>
                <div class="flex gap-4">
                    <div class="flex-grow">
                        <input type="file" name="file_excel" id="file_excel" class="hidden" accept=".xlsx,.xls"
                            required>
                        <label for="file_excel"
                            class="flex flex-col items-center justify-center w-full h-32 border border-dashed border-gray-400 bg-gray-50/30 hover:bg-white hover:border-gray-900 transition-all cursor-pointer group">
                            <span id="name_excel"
                                class="text-[10px] font-bold text-gray-400 text-center px-4 uppercase tracking-widest group-hover:text-gray-900 transition-colors">
                                Seleccione el archivo .xlsx
                            </span>
                        </label>
                    </div>
                    <button type="button" id="btn_preanalizar" onclick="preanalizarExcel()"
                        class="bg-gray-100 border border-gray-900 text-gray-900 px-6 font-bold text-[10px] tracking-widest uppercase hover:bg-gray-900 hover:text-white transition-all disabled:opacity-30 disabled:cursor-not-allowed"
                        disabled>
                        Pre-analizar
                    </button>
                </div>
            </div>

            <!-- PANEL DE MAPEO DE COLUMNAS -->
            <div id="mapping_panel"
                class="hidden space-y-6 p-8 border-2 border-gray-900 bg-gray-50 animate-in zoom-in duration-300">
                <label
                    class="block text-[10px] font-mono font-bold text-gray-900 uppercase tracking-[0.2em] mb-4 underline">Mapeo
                    Manual de Columnas</label>

                <div class="grid grid-cols-3 gap-8">
                    <div class="space-y-3">
                        <label class="block text-[9px] font-bold text-gray-500 uppercase italic">Columna Número Anterior
                            (CICA/LC)</label>
                        <select name="col_ant" id="col_ant"
                            class="w-full bg-white border border-gray-900 p-3 text-[11px] font-mono focus:ring-1 focus:ring-gray-900 outline-none">
                            <option value="">Detectando...</option>
                        </select>
                    </div>
                    <div class="space-y-3">
                        <label class="block text-[9px] font-bold text-gray-500 uppercase italic">Columna Número Nuevo
                            (SNC)</label>
                        <select name="col_snc" id="col_snc"
                            class="w-full bg-white border border-gray-900 p-3 text-[11px] font-mono focus:ring-1 focus:ring-gray-900 outline-none">
                            <option value="">Detectando...</option>
                        </select>
                    </div>
                    <div class="space-y-3">
                        <label class="block text-[9px] font-bold text-gray-500 uppercase italic">Columna Estado</label>
                        <select name="col_estado" id="col_estado"
                            class="w-full bg-white border border-gray-900 p-3 text-[11px] font-mono focus:ring-1 focus:ring-gray-900 outline-none">
                            <option value="">Detectando...</option>
                        </select>
                    </div>
                </div>
                <p class="text-[9px] text-gray-400 font-mono mt-4 uppercase">Verifique que las columnas coincidan con el
                    contenido real de su archivo antes de procesar.</p>
            </div>

            <!-- CARGA GDBS (SOLO FASE 2) -->
            <div id="gdb_inputs" class="hidden space-y-4 animate-in fade-in duration-300">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">GDB
                            Formal</label>
                        <input type="file" name="archivo_gdb_formal" id="gdb_f" class="hidden" accept=".zip">
                        <label for="gdb_f"
                            class="flex flex-col items-center justify-center h-20 border border-dashed border-gray-200 rounded-xl bg-gray-50/30 hover:bg-white hover:border-accent transition-all cursor-pointer">
                            <span class="material-symbols-outlined text-gray-300">map</span>
                            <span class="text-[10px] text-gray-400 mt-1" id="label_gdb_f">ZIP Capas Normal</span>
                        </label>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">GDB
                            Informal</label>
                        <input type="file" name="archivo_gdb_informal" id="gdb_i" class="hidden" accept=".zip">
                        <label for="gdb_i"
                            class="flex flex-col items-center justify-center h-20 border border-dashed border-gray-200 rounded-xl bg-gray-50/30 hover:bg-white hover:border-accent transition-all cursor-pointer">
                            <span class="material-symbols-outlined text-gray-300">location_on</span>
                            <span class="text-[10px] text-gray-400 mt-1" id="label_gdb_i">ZIP Capas Informal</span>
                        </label>
                    </div>
                </div>
            </div>

            <button type="submit" id="btn_submit"
                class="w-full bg-gray-900 text-white py-5 border border-gray-900 hover:bg-white hover:text-gray-900 transition-all font-mono font-bold text-[10px] tracking-[0.3em] flex justify-center items-center gap-4 uppercase active:scale-[0.98]">
                <span class="material-symbols-outlined font-light">verified_user</span> Ejecutar Validación
            </button>
        </form>
    </div>

    {% endif %}

    <!-- RESULTADOS (SI EXISTEN) -->
    {% if resultados %}
    <div id="resultado_renum" class="space-y-10 uppercase font-mono">
        <div class="flex items-center justify-between bg-white p-10 border border-gray-900">
            <div class="flex items-center gap-6">
                <div class="w-14 h-14 bg-gray-900 flex items-center justify-center text-white">
                    <span class="material-symbols-outlined text-3xl font-light">fact_check</span>
                </div>
                <div>
                    <h3
                        class="text-2xl font-display font-bold text-gray-900 flex items-center gap-4 uppercase tracking-tighter">
                        <span class="material-symbols-outlined text-gray-900 font-light">analytics</span>
                        Reporte de Renumeración // Resultados
                    </h3>
                    <p class="text-[10px] text-gray-500 mt-2 font-mono">Predios Auditados: {{ resultados.total_auditado
                        }}</p>
                </div>
            </div>
            <div class="flex gap-4">
                <a href="/renumeracion/excel"
                    class="bg-white border border-gray-900 text-gray-900 px-6 py-3 text-[10px] font-bold hover:bg-gray-900 hover:text-white transition-all flex items-center gap-3 tracking-widest">
                    <span class="material-symbols-outlined text-[18px] font-light">table_view</span> Descargar Excel
                </a>
                <a href="/renumeracion/pdf"
                    class="bg-white border border-red-600 text-red-600 px-6 py-3 text-[10px] font-bold hover:bg-red-600 hover:text-white transition-all flex items-center gap-3 tracking-widest">
                    <span class="material-symbols-outlined text-[18px] font-light">picture_as_pdf</span> Descargar PDF
                </a>
                <a href="/clear_renumeracion"
                    class="bg-gray-900 text-white px-6 py-3 text-[10px] font-bold hover:bg-white hover:text-gray-900 border border-gray-900 transition-all flex items-center gap-3 tracking-widest">
                    <span class="material-symbols-outlined text-[18px] font-light">refresh</span> Reiniciar
                </a>
            </div>
        </div>

        <!-- SECCIÓN 1: AUDITORÍA ALFANUMÉRICA -->
        <div class="space-y-4">
            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">description</span>
                {% if resultados.fase_ejecutada == 1 %}Fase 1: Validación Alfanumérica{% else %}Fase 1: Base
                Alfanumérica (Pre-validada){% endif %}
            </h4>


            <div
                class="bg-white border border-gray-900 overflow-hidden mt-6 {% if resultados.fase_ejecutada == 2 and not resultados.errores %}hidden{% endif %}">
                <div class="p-8 border-b border-gray-900 bg-gray-50/30">
                    <h4
                        class="text-[10px] font-bold text-gray-900 uppercase tracking-[0.2em] border-l-2 border-gray-900 pl-4">
                        Errores Detectados ({{ resultados.errores|length }})</h4>
                </div>
                <div class="overflow-x-auto max-h-[400px] overflow-y-auto custom-scrollbar">
                    {% if resultados.errores %}
                    <table class="w-full text-left border-collapse text-[11px]">
                        <thead class="sticky top-0 bg-white border-b border-gray-100 text-gray-400 font-bold uppercase">
                            <tr>
                                <th class="px-6 py-3">Validación</th>
                                <th class="px-6 py-3">Detalle del Error</th>
                                <th class="px-6 py-3">P. Anterior</th>
                                <th class="px-6 py-3">P. Nuevo (SNC)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50">
                            {% for err in resultados.errores %}
                            <tr class="hover:bg-red-50/30 transition-colors uppercase">
                                <td class="px-8 py-5"><span class="font-bold text-red-600 text-xs">{{ err.REGLA
                                        }}</span>
                                </td>
                                <td class="px-8 py-5 text-gray-600 text-[10px] font-mono">{{ err.DETALLE }}</td>
                                <td class="px-8 py-5 font-mono text-gray-400">{{ err.ANTERIOR }}</td>
                                <td class="px-8 py-5 font-mono font-bold text-gray-900">{{ err.NUEVO }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="p-12 text-center">
                        <span class="material-symbols-outlined text-5xl text-green-200 mb-2">verified</span>
                        <h5 class="text-sm font-bold text-gray-900">Alfanumérico impecable</h5>
                        <p class="text-[11px] text-gray-400">No se detectaron errores de secuencia o lógica en los
                            códigos.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-4">
            {% for counter in resultados.dashboard_counters %}
            <div class="bg-white border border-gray-900 p-6 flex flex-col items-center justify-center space-y-2">
                <span class="material-symbols-outlined text-4xl text-gray-900">{{ counter.icon }}</span>
                <p class="text-xs font-bold text-gray-900 uppercase tracking-widest text-center">{{ counter.label }}</p>
                <p class="text-3xl font-bold text-gray-900">{{ counter.value }}</p>
            </div>
            {% endfor %}
        </div>

        <!-- SECCIÓN 2: AUDITORÍA GEOGRÁFICA -->
        {% if resultados.fase_ejecutada == 2 %}
        <div class="space-y-6">
            <h4 class="text-[10px] font-mono font-bold text-gray-400 uppercase tracking-widest flex items-center gap-3">
                <span class="material-symbols-outlined text-sm font-light">map</span> PHASE_02: SPATIAL_OVERLAY_CRUNCH
                (GDB)
            </h4>

            <div class="bg-white border border-gray-900 overflow-hidden">
                <div class="p-8 border-b border-gray-900 bg-gray-50/30 flex justify-between items-center">
                    <h4
                        class="text-[10px] font-bold text-gray-900 uppercase tracking-[0.2em] border-l-2 border-gray-900 pl-4">
                        GEOSPATIAL_EXCEPTION_LEDGER ({{ resultados.errores_geo|length }})</h4>
                </div>
                <div class="overflow-x-auto max-h-[400px] overflow-y-auto custom-scrollbar">
                    {% if resultados.errores_geo %}
                    <table class="w-full text-left border-collapse text-[10px] uppercase font-mono">
                        <thead
                            class="sticky top-0 bg-gray-900 border-b border-gray-900 text-gray-400 font-bold tracking-widest">
                            <tr>
                                <th class="px-8 py-5">INCIDENCE_TYPE</th>
                                <th class="px-8 py-5">NODE_ID</th>
                                <th class="px-8 py-5">DB_STATUS</th>
                                <th class="px-8 py-5">RECOM_ACTION</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for err in resultados.errores_geo %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-8 py-5">
                                    <div class="flex flex-col gap-1">
                                        <span class="text-gray-900 font-bold">{{ err.TIPO }}</span>
                                        <span class="text-gray-400 font-normal text-[9px]">{{ err.DETALLE }}</span>
                                    </div>
                                </td>
                                <td class="px-8 py-5 font-bold text-gray-900">{{ err.CODIGO }}</td>
                                <td class="px-8 py-5">
                                    <span
                                        class="px-3 py-1 border {% if err.ESTADO_BD == 'ACTIVO' %}border-gray-900 text-gray-900{% elif err.ESTADO_BD == 'NO EXISTE EN BD' %}border-red-600 text-red-600{% else %}border-gray-400 text-gray-400{% endif %} font-bold text-[9px] tracking-widest">
                                        {{ err.ESTADO_BD }}
                                    </span>
                                </td>
                                <td class="px-8 py-5 text-gray-900 font-bold tracking-tighter">{{ err.ACCION_SUGERIDA }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="p-16 text-center">
                        <span class="material-symbols-outlined text-5xl text-gray-200 mb-4 font-light">public</span>
                        <h5 class="text-xs font-bold text-gray-900 tracking-widest">GEOSPATIAL_INTEGRITY_VERIFIED</h5>
                        <p class="text-[10px] text-gray-400 mt-2">All GDB vectors align with renumbering report
                            signatures.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block help_content %}
<div class="space-y-10 font-mono text-[11px] text-gray-900 uppercase">
    <section>
        <h4 class="border-b border-gray-900 pb-2 mb-4 flex items-center gap-3 font-bold tracking-widest">
            <span class="material-symbols-outlined font-light">verified</span>
            01. Objetivo de la Auditoría
        </h4>
        <p>Asegura que el cambio de los números prediales antiguos a los nuevos siga las reglas técnicas del IGAC. Evita
            que se pierda la historia de los predios durante la migración.</p>
    </section>

    <section>
        <h4 class="border-b border-gray-900 pb-2 mb-4 flex items-center gap-3 font-bold tracking-widest">
            <span class="material-symbols-outlined font-light">rule</span>
            02. Reglas de Validación
        </h4>
        <div class="space-y-4">
            <div class="border border-gray-200 p-4">
                <p class="font-bold mb-1 underline">Unicidad</p>
                <p class="text-gray-500">Un número nuevo no puede estar repetido en dos predios diferentes.</p>
            </div>
            <div class="border border-gray-200 p-4">
                <p class="font-bold mb-1 underline">Permanencia</p>
                <p class="text-gray-500">Si un predio ya tenía un número oficial, este no debería cambiar
                    injustificadamente.</p>
            </div>
            <div class="border border-gray-200 p-4">
                <p class="font-bold mb-1 underline">Geografía (Fase 2)</p>
                <p class="text-gray-500">El número predial debe corresponder exactamente con su ubicación en el mapa.
                </p>
            </div>
        </div>
    </section>

    <section class="bg-gray-900 p-8 border border-gray-900 text-white">
        <h4
            class="font-bold text-[11px] uppercase tracking-widest mb-4 flex items-center gap-3 border-b border-gray-700 pb-2">
            <span class="material-symbols-outlined text-gray-400 font-light">info</span>
            Importante
        </h4>
        <p class="text-[10px] text-gray-400 italic">Esta herramienta ayuda a detectar errores antes de que la base de
            datos oficial se vea afectada por malas numeraciones.</p>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateRadioSelection() {
        const r1 = document.querySelector('input[name="tipo"][value="1"]');
        const r2 = document.querySelector('input[name="tipo"][value="2"]');

        if (document.getElementById('label_tipo_1')) document.getElementById('label_tipo_1').classList.toggle('border-gray-900', r1.checked);
        if (document.getElementById('label_tipo_1')) document.getElementById('label_tipo_1').classList.toggle('bg-gray-50', r1.checked);
        if (document.getElementById('label_tipo_2')) document.getElementById('label_tipo_2').classList.toggle('border-gray-900', r2.checked);
        if (document.getElementById('label_tipo_2')) document.getElementById('label_tipo_2').classList.toggle('bg-gray-50', r2.checked);
    }

    function toggleFase(val) {
        const w2 = document.getElementById('warning_fase2');
        const gdb = document.getElementById('gdb_inputs');

        if (val == "2") {
            if (w2) w2.classList.remove('hidden');
            if (gdb) gdb.classList.remove('hidden');
        } else {
            if (w2) w2.classList.add('hidden');
            if (gdb) gdb.classList.add('hidden');
        }
    }

    async function preanalizarExcel() {
        const fileInput = document.getElementById('file_excel');
        const btn = document.getElementById('btn_preanalizar');
        const panel = document.getElementById('mapping_panel');
        const selAnt = document.getElementById('col_ant');
        const selSnc = document.getElementById('col_snc');
        const selEstado = document.getElementById('col_estado'); // Added for col_estado

        if (!fileInput.files.length) return;

        btn.disabled = true;
        btn.innerHTML = "Analizando...";

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const response = await fetch('/renumeracion/detectar-columnas', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.error) {
                alert("Error: " + data.error);
            } else {
                // Limpiar y poblar
                selAnt.innerHTML = "";
                selSnc.innerHTML = "";
                selEstado.innerHTML = ""; // Clear for col_estado

                data.columnas.forEach(col => {
                    const opt1 = document.createElement('option');
                    opt1.value = col; opt1.textContent = col;
                    selAnt.appendChild(opt1);

                    const opt2 = document.createElement('option');
                    opt2.value = col; opt2.textContent = col;
                    selSnc.appendChild(opt2);

                    const opt3 = document.createElement('option'); // Option for col_estado
                    opt3.value = col; opt3.textContent = col;
                    selEstado.appendChild(opt3);
                });

                // Auto-detectar
                const colAntMatch = data.columnas.find(c => c.toUpperCase().includes('CICA') || c.toUpperCase().includes('ANTERIOR') || c.toUpperCase().includes('LC'));
                const colSncMatch = data.columnas.find(c => c.toUpperCase().includes('SNC') || c.toUpperCase().includes('NUEVO'));
                const colEstadoMatch = data.columnas.find(c => c.toUpperCase().includes('ESTADO') || c.toUpperCase().includes('STATUS')); // Auto-detect for col_estado

                if (colAntMatch) selAnt.value = colAntMatch;
                if (colSncMatch) selSnc.value = colSncMatch;
                if (colEstadoMatch) selEstado.value = colEstadoMatch; // Set value for col_estado

                panel.classList.remove('hidden');
            }
        } catch (e) {
            alert("Error de conexión");
        } finally {
            btn.disabled = false;
            btn.innerHTML = "Pre-analizar";
        }
    }

    {% if not resultados %}
    document.getElementById('file_excel').addEventListener('change', (e) => {
        const btnPre = document.getElementById('btn_preanalizar');
        const nameDisplay = document.getElementById('name_excel');
        if (e.target.files.length > 0) {
            nameDisplay.innerHTML = '<span class="text-gray-900 font-bold uppercase tracking-tight">✓ ' + e.target.files[0].name.toUpperCase() + '</span>';
            btnPre.disabled = false;
            // Reset panel if file changes
            document.getElementById('mapping_panel').classList.add('hidden');
        } else {
            btnPre.disabled = true;
        }
    });

    const setupFileLabel = (inputId, labelId) => {
        const el = document.getElementById(inputId);
        if (el) {
            el.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    document.getElementById(labelId).innerHTML = '<span class="text-gray-900 font-bold uppercase text-[9px]">✓ ' + e.target.files[0].name.toUpperCase() + '</span>';
                }
            });
        }
    };

    setupFileLabel('gdb_f', 'label_gdb_f');
    setupFileLabel('gdb_i', 'label_gdb_i');

    updateRadioSelection();
    {% endif %}
</script>
{% endblock %}