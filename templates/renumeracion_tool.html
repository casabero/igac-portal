{% extends "base.html" %}

{% block title %}Auditoría de Renumeración - IGAC Apps{% endblock %}

{% block page_title %}Auditoría de Renumeración Catastral{% endblock %}

{% block content %}
<div class="max-w-[1400px] mx-auto">
    <!-- FORMULARIO DE CARGA (SI NO HAY RESULTADOS) -->
    {% if not resultados %}
    <div class="max-w-xl mx-auto bg-white p-8 rounded-2xl border border-gray-200 shadow-sm mt-4">
        <h2 class="text-xl font-bold mb-6 text-gray-900 flex items-center gap-2">
            <span class="material-symbols-outlined text-accent">rule</span> Auditoría de Renumeración
        </h2>

        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            <!-- PASO 1: CONFIGURACIÓN DE TIPO -->
            <div class="space-y-4">
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Paso 1: Tipo de
                    Reporte</label>
                <div class="grid grid-cols-2 gap-4">
                    <label
                        class="relative flex flex-col p-4 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all border-gray-200"
                        id="label_tipo_1">
                        <input type="radio" name="tipo" value="1"
                            class="absolute top-4 right-4 text-accent focus:ring-accent" checked
                            onchange="updateRadioSelection()">
                        <span class="text-xs font-bold text-gray-900">CICA</span>
                        <span class="text-[10px] text-gray-400 mt-1">SNC vs CICA (IGAC)</span>
                    </label>
                    <label
                        class="relative flex flex-col p-4 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all border-gray-200"
                        id="label_tipo_2">
                        <input type="radio" name="tipo" value="2"
                            class="absolute top-4 right-4 text-accent focus:ring-accent"
                            onchange="updateRadioSelection()">
                        <span class="text-xs font-bold text-gray-900">Operadores</span>
                        <span class="text-[10px] text-gray-400 mt-1">SNC vs Gestor/Operador</span>
                    </label>
                </div>
            </div>

            <!-- PASO 2: SELECCIÓN DE FASE -->
            <div class="space-y-4">
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Paso 2: Fase de
                    Auditoría</label>
                <div class="grid grid-cols-2 gap-4">
                    <label
                        class="relative flex flex-col p-4 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all border-gray-200"
                        id="label_fase_1">
                        <input type="radio" name="fase" value="1"
                            class="absolute top-4 right-4 text-accent focus:ring-accent" checked
                            onchange="updateFaseSelection()">
                        <span class="text-xs font-bold text-gray-900">Fase 1</span>
                        <span class="text-[10px] text-gray-400 mt-1">Validación Alfanumérica</span>
                    </label>
                    <label
                        class="relative flex flex-col p-4 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all border-gray-200"
                        id="label_fase_2">
                        <input type="radio" name="fase" value="2"
                            class="absolute top-4 right-4 text-accent focus:ring-accent"
                            onchange="updateFaseSelection()">
                        <span class="text-xs font-bold text-gray-900">Fase 2</span>
                        <span class="text-[10px] text-gray-400 mt-1">Cruce Geográfico (GDB)</span>
                    </label>
                </div>
            </div>

            <!-- ADVERTENCIA FASE 2 (OCULTA POR DEFECTO) -->
            <div id="warning_fase2" class="hidden animate-in fade-in slide-in-from-top-2 duration-300">
                <div class="p-4 bg-amber-50 border border-amber-100 rounded-xl flex gap-3">
                    <span class="material-symbols-outlined text-amber-600 text-sm">warning</span>
                    <p class="text-[10px] text-amber-800 leading-relaxed font-medium">
                        <b>Atención:</b> Para ejecutar la Fase 2 se asume que los predios ya cuentan con su respectiva
                        validación técnica (Fase 1).
                    </p>
                </div>
            </div>

            <!-- CARGA EXCEL (OBLIGATORIA) -->
            <div class="space-y-3">
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Paso 3: Reporte SNC
                    (.xlsx)</label>
                <input type="file" name="archivo_excel" id="archivo_excel" class="hidden" accept=".xlsx" required>
                <label for="archivo_excel"
                    class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-gray-200 rounded-2xl bg-gray-50/50 hover:bg-white hover:border-accent transition-all cursor-pointer group">
                    <span
                        class="material-symbols-outlined text-2xl text-gray-300 mb-1 group-hover:text-accent group-hover:scale-110 transition-transform">upload_file</span>
                    <span class="text-[11px] font-medium text-gray-500" id="file_label">Seleccionar archivo Excel</span>
                </label>
            </div>

            <!-- CARGA GDBS (SOLO FASE 2) -->
            <div id="gdb_inputs" class="hidden space-y-4 animate-in fade-in duration-300">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">GDB
                            Formal</label>
                        <input type="file" name="archivo_gdb_formal" id="gdb_f" class="hidden" accept=".zip">
                        <label for="gdb_f"
                            class="flex flex-col items-center justify-center h-20 border border-dashed border-gray-200 rounded-xl bg-gray-50/30 hover:bg-white hover:border-accent transition-all cursor-pointer">
                            <span class="material-symbols-outlined text-gray-300">map</span>
                            <span class="text-[10px] text-gray-400 mt-1" id="label_gdb_f">ZIP Capas Normal</span>
                        </label>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">GDB
                            Informal</label>
                        <input type="file" name="archivo_gdb_informal" id="gdb_i" class="hidden" accept=".zip">
                        <label for="gdb_i"
                            class="flex flex-col items-center justify-center h-20 border border-dashed border-gray-200 rounded-xl bg-gray-50/30 hover:bg-white hover:border-accent transition-all cursor-pointer">
                            <span class="material-symbols-outlined text-gray-300">location_on</span>
                            <span class="text-[10px] text-gray-400 mt-1" id="label_gdb_i">ZIP Capas Informal</span>
                        </label>
                    </div>
                </div>
            </div>

            <button type="submit"
                class="w-full bg-gray-900 text-white py-4 rounded-2xl hover:bg-accent hover:shadow-xl hover:shadow-accent/20 transition-all font-bold text-sm tracking-widest flex justify-center items-center gap-3">
                <span class="material-symbols-outlined">analytics</span> EJECUTAR VALIDACIÓN
            </button>
        </form>
    </div>

    {% endif %}

    <!-- RESULTADOS (SI EXISTEN) -->
    {% if resultados %}
    <div id="resultado_renum" class="space-y-8">
        <div class="flex items-center justify-between bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-accent/10 rounded-xl flex items-center justify-center text-accent">
                    <span class="material-symbols-outlined text-3xl">fact_check</span>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Resultados de Auditoría Integrada</h3>
                    <p class="text-xs text-gray-400">Total predios activos auditados: <b>{{ resultados.total_auditado
                            }}</b></p>
                </div>
            </div>
            <div class="flex gap-3">
                <a href="/renumeracion/excel"
                    class="bg-gray-900 text-white px-5 py-3 rounded-xl text-xs font-bold hover:bg-accent transition-all flex items-center gap-2 shadow-lg shadow-gray-900/10">
                    <span class="material-symbols-outlined text-[18px]">table_view</span> Excel Detallado
                </a>
                <a href="/renumeracion/pdf"
                    class="bg-red-600 text-white px-5 py-3 rounded-xl text-xs font-bold hover:bg-red-700 transition-all flex items-center gap-2 shadow-lg shadow-red-600/10">
                    <span class="material-symbols-outlined text-[18px]">picture_as_pdf</span> Informe PDF
                </a>
                <a href="/clear_renumeracion"
                    class="bg-white border border-red-100 text-red-600 px-4 py-3 rounded-xl text-xs font-bold hover:bg-red-50 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">delete_sweep</span> Nueva Auditoría
                </a>
            </div>
        </div>

        <!-- SECCIÓN 1: AUDITORÍA ALFANUMÉRICA -->
        <div class="space-y-4">
            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">description</span>
                {% if resultados.fase_ejecutada == 1 %}Fase 1: Validación Alfanumérica{% else %}Fase 1: Base
                Alfanumérica (Pre-validada){% endif %}
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                {% for i in range(1, 7) %}
                {% set rule_key = i ~ ". " %}
                {% set count = 0 %}
                {% for k, v in resultados.stats.items() %}
                {% if rule_key in k %}{% set count = v %}{% endif %}
                {% endfor %}
                <div
                    class="bg-white p-4 rounded-2xl border {% if count > 0 %}border-red-100 bg-red-50/30{% else %}border-gray-100{% endif %} shadow-sm flex flex-col gap-1 transition-all hover:scale-[1.02]">
                    <p
                        class="text-[9px] {% if count > 0 %}text-red-400{% else %}text-gray-400{% endif %} font-bold uppercase">
                        Regla {{ i }}</p>
                    <p
                        class="text-2xl font-display font-bold {% if count > 0 %}text-red-600{% else %}text-gray-900{% endif %}">
                        {{ count }}</p>
                </div>
                {% endfor %}
            </div>

            <div
                class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden mt-4 {% if resultados.fase_ejecutada == 2 and not resultados.errores %}hidden{% endif %}">
                <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/30">
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Alertas Alfanuméricas ({{
                        resultados.errores|length }})</h4>
                </div>
                <div class="overflow-x-auto max-h-[400px] overflow-y-auto custom-scrollbar">
                    {% if resultados.errores %}
                    <table class="w-full text-left border-collapse text-[11px]">
                        <thead class="sticky top-0 bg-white border-b border-gray-100 text-gray-400 font-bold uppercase">
                            <tr>
                                <th class="px-6 py-3">Validación</th>
                                <th class="px-6 py-3">Detalle del Error</th>
                                <th class="px-6 py-3">P. Anterior</th>
                                <th class="px-6 py-3">P. Nuevo (SNC)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50">
                            {% for err in resultados.errores %}
                            <tr class="hover:bg-red-50/30 transition-colors">
                                <td class="px-6 py-4"><span class="font-bold text-red-600">{{ err.REGLA }}</span></td>
                                <td class="px-6 py-4 text-gray-600">{{ err.DETALLE }}</td>
                                <td class="px-6 py-4 font-mono text-gray-400">{{ err.ANTERIOR }}</td>
                                <td class="px-6 py-4 font-mono font-bold text-gray-900">{{ err.NUEVO }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="p-12 text-center">
                        <span class="material-symbols-outlined text-5xl text-green-200 mb-2">verified</span>
                        <h5 class="text-sm font-bold text-gray-900">Alfanumérico impecable</h5>
                        <p class="text-[11px] text-gray-400">No se detectaron errores de secuencia o lógica en los
                            códigos.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- SECCIÓN 2: AUDITORÍA GEOGRÁFICA -->
        {% if resultados.fase_ejecutada == 2 %}
        <div class="space-y-4">
            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">map</span> Fase 2: Cruce Geográfico (GDB)
            </h4>

            <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/30 flex justify-between items-center">
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Alertas
                        Geográficas ({{ resultados.errores_geo|length }})</h4>
                </div>
                <div class="overflow-x-auto max-h-[400px] overflow-y-auto custom-scrollbar">
                    {% if resultados.errores_geo %}
                    <table class="w-full text-left border-collapse text-[11px]">
                        <thead class="sticky top-0 bg-white border-b border-gray-100 text-gray-400 font-bold uppercase">
                            <tr>
                                <th class="px-6 py-3">Incidencia</th>
                                <th class="px-6 py-3">Código Involucrado</th>
                                <th class="px-6 py-3">Estado en BD</th>
                                <th class="px-6 py-3">Acción Recomendada</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50">
                            {% for err in resultados.errores_geo %}
                            <tr class="hover:bg-amber-50/30 transition-colors">
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 rounded-md text-[9px] font-bold flex flex-col gap-1">
                                        <span class="text-gray-900">{{ err.TIPO }}</span>
                                        <span class="text-gray-400 font-normal">{{ err.DETALLE }}</span>
                                    </span>
                                </td>
                                <td class="px-6 py-4 font-mono font-bold text-gray-900">{{ err.CODIGO }}</td>
                                <td class="px-6 py-4">
                                    <span
                                        class="px-2 py-0.5 rounded-full {% if err.ESTADO_BD == 'ACTIVO' %}bg-green-100 text-green-700{% elif err.ESTADO_BD == 'NO EXISTE EN BD' %}bg-red-100 text-red-700{% else %}bg-gray-100 text-gray-600{% endif %} font-bold text-[9px]">
                                        {{ err.ESTADO_BD }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-blue-600 font-medium">{{ err.ACCION_SUGERIDA }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="p-12 text-center">
                        <span class="material-symbols-outlined text-5xl text-green-200 mb-2">public</span>
                        <h5 class="text-sm font-bold text-gray-900">Consistencia Geográfica PerfectA</h5>
                        <p class="text-[11px] text-gray-400">Todos los predios de la GDB coinciden con el reporte de
                            renumeración.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block help_content %}
<div class="space-y-8 text-gray-600">
    <section>
        <h4 class="text-primary font-bold text-sm uppercase tracking-wider border-b pb-2 mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-accent">rule</span>
            Auditoría de Renumeración Integral
        </h4>
        <p class="text-sm">Esta herramienta valida de forma unificada el proceso de cambio de códigos prediales (SNC).
            El proceso se divide en dos fases fundamentales:</p>
        <div class="mt-4 space-y-3">
            <div class="flex gap-3">
                <span
                    class="w-6 h-6 rounded-full bg-accent text-white flex items-center justify-center text-[10px] font-bold shrink-0">1</span>
                <div>
                    <p class="text-xs font-bold text-gray-900">Fase Alfanumérica (Obligatoria)</p>
                    <p class="text-[11px]">Valida las 6 reglas técnicas del IGAC (Unicidad, Permanencia, Limpieza,
                        Consecutivos y Reinicios). Requiere el Excel del SNC con columna de "Estado".</p>
                </div>
            </div>
            <div class="flex gap-3">
                <span
                    class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-[10px] font-bold shrink-0">2</span>
                <div>
                    <p class="text-xs font-bold text-gray-900">Fase Geográfica (Opcional)</p>
                    <p class="text-[11px]">Cruza el Excel con las capas de la GDB (.zip). Identifica predios activos
                        dibujados que no están en el reporte y viceversa.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="bg-amber-50 p-6 rounded-2xl border border-amber-100">
        <h4 class="text-amber-800 font-bold text-xs uppercase tracking-wider mb-2 flex items-center gap-2">
            <span class="material-symbols-outlined text-amber-600">warning</span>
            IMPORTANTE: Cargue Alfanumérico
        </h4>
        <p class="text-[11px] text-amber-700 leading-relaxed">
            Es <b>indispensable</b> que el archivo Excel contenga todos los registros (Activos y Cancelados) para que la
            fase geográfica pueda realizar el cruce correctamente e identificar si un polígono "sobrante" corresponde a
            un predio ya cancelado en sistema.
        </p>
    </section>

    <section>
        <h4 class="text-primary font-bold text-sm uppercase tracking-wider border-b pb-2 mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-accent">help</span>
            Capas Auditadas en GDB
        </h4>
        <ul class="text-[11px] space-y-1 list-disc pl-4">
            <li><b>Formal:</b> U_TERRENO, R_TERRENO, TERRENO</li>
            <li><b>Informal:</b> U_TERRENO_INFORMAL, R_TERRENO_INFORMAL, TERRENO_INFORMAL</li>
        </ul>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateRadioSelection() {
        const r1 = document.querySelector('input[name="tipo"][value="1"]');
        const r2 = document.querySelector('input[name="tipo"][value="2"]');

        document.getElementById('label_tipo_1').classList.toggle('border-accent', r1.checked);
        document.getElementById('label_tipo_1').classList.toggle('bg-blue-50/30', r1.checked);
        document.getElementById('label_tipo_2').classList.toggle('border-accent', r2.checked);
        document.getElementById('label_tipo_2').classList.toggle('bg-blue-50/30', r2.checked);
    }

    function updateFaseSelection() {
        const f1 = document.querySelector('input[name="fase"][value="1"]');
        const f2 = document.querySelector('input[name="fase"][value="2"]');

        const w2 = document.getElementById('warning_fase2');
        const gdb = document.getElementById('gdb_inputs');

        // Estilos de labels
        document.getElementById('label_fase_1').classList.toggle('border-accent', f1.checked);
        document.getElementById('label_fase_1').classList.toggle('bg-blue-50/30', f1.checked);
        document.getElementById('label_fase_2').classList.toggle('border-accent', f2.checked);
        document.getElementById('label_fase_2').classList.toggle('bg-blue-50/30', f2.checked);

        // Visibilidad de secciones
        if (f2.checked) {
            w2.classList.remove('hidden');
            gdb.classList.remove('hidden');
        } else {
            w2.classList.add('hidden');
            gdb.classList.add('hidden');
        }
    }

    {% if not resultados %}
    document.getElementById('archivo_excel').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            document.getElementById('file_label').innerHTML = `<b class="text-accent tracking-normal">Excel: ${e.target.files[0].name}</b>`;
        }
    });
    document.getElementById('gdb_f').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            document.getElementById('label_gdb_f').innerHTML = `<b class="text-blue-600">✓ ${e.target.files[0].name}</b>`;
        }
    });
    document.getElementById('gdb_i').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            document.getElementById('label_gdb_i').innerHTML = `<b class="text-blue-600">✓ ${e.target.files[0].name}</b>`;
        }
    });
    updateRadioSelection();
    updateFaseSelection();
    {% endif %}
</script>
{% endblock %}